<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPL 2026 Fantasy League</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--green:#00C853;--dark-green:#007B33;--gold:#FFD600;--red:#FF1744;--purple:#a259ff;--bg:#0d1a0d;--card:#132213;--border:#1f3d1f;--text:#e8f5e9;--muted:#6a9b6a;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;
  background-image:radial-gradient(ellipse 60% 40% at 50% -10%,rgba(0,200,83,.15) 0%,transparent 70%),
  repeating-linear-gradient(0deg,transparent,transparent 40px,rgba(0,200,83,.02) 40px,rgba(0,200,83,.02) 41px),
  repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(0,200,83,.02) 40px,rgba(0,200,83,.02) 41px);}
header{text-align:center;padding:2rem 1rem 1.2rem;border-bottom:1px solid var(--border);}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(2rem,7vw,4rem);letter-spacing:4px;
  background:linear-gradient(135deg,var(--green),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.tagline{color:var(--muted);font-size:.82rem;letter-spacing:3px;text-transform:uppercase;margin-top:.3rem;}
.sync-status{display:inline-flex;align-items:center;gap:.4rem;font-size:.75rem;margin-top:.4rem;padding:.2rem .7rem;border-radius:99px;border:1px solid var(--border);}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--muted);}
.sync-dot.ok{background:var(--green);}
.sync-dot.err{background:var(--red);}
.sync-dot.loading{background:var(--gold);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
nav{display:flex;justify-content:center;gap:.5rem;padding:1rem;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.tab-btn{background:transparent;border:1px solid var(--border);color:var(--muted);padding:.5rem 1.2rem;border-radius:99px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;transition:all .2s;}
.tab-btn.active,.tab-btn:hover{background:var(--green);border-color:var(--green);color:#000;font-weight:600;}
.container{max-width:1200px;margin:0 auto;padding:1.5rem 1rem;}
.screen{display:none;}.screen.active{display:block;}
.section-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:2px;color:var(--green);margin-bottom:1rem;}
.subsection{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:1.5px;color:var(--muted);margin:1.2rem 0 .6rem;}
input,select{background:var(--card);border:1px solid var(--border);color:var(--text);padding:.6rem .85rem;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.9rem;outline:none;transition:border-color .2s;width:100%;}
input:focus,select:focus{border-color:var(--green);}input::placeholder{color:var(--muted);}
label{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);display:block;margin-bottom:.3rem;}
.input-group{display:flex;flex-direction:column;gap:.3rem;}
.btn{background:var(--green);color:#000;border:none;padding:.7rem 1.8rem;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.5rem;}
.btn:hover{background:var(--gold);transform:translateY(-1px);}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-sm{padding:.45rem 1rem;font-size:.85rem;letter-spacing:1px;}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);padding:.45rem 1rem;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s;}
.btn-ghost:hover{border-color:var(--green);color:var(--green);}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.2rem;}
.info-box{background:rgba(0,200,83,.07);border:1px solid rgba(0,200,83,.2);border-radius:10px;padding:.9rem 1.1rem;font-size:.85rem;color:var(--muted);margin-bottom:1.2rem;}
.info-box strong{color:var(--text);}
.scoring-key{display:flex;gap:.7rem;margin-bottom:1.2rem;flex-wrap:wrap;}
.key-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.45rem .9rem;font-size:.8rem;display:flex;align-items:center;gap:.5rem;}
.key-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.empty-state{text-align:center;color:var(--muted);padding:2rem 1rem;font-size:.88rem;}
.btn-row{display:flex;gap:.8rem;flex-wrap:wrap;align-items:center;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
@keyframes spin{to{transform:rotate(360deg)}}

/* DRAFT */
.draft-layout{display:grid;grid-template-columns:240px 1fr;gap:1.5rem;}
@media(max-width:780px){.draft-layout{grid-template-columns:1fr;}}
.participant-sidebar .card{position:sticky;top:1rem;}
.participant-list{display:flex;flex-direction:column;gap:.4rem;max-height:420px;overflow-y:auto;margin-bottom:.8rem;}
.p-item{display:flex;align-items:center;justify-content:space-between;padding:.5rem .7rem;border-radius:7px;font-size:.88rem;cursor:pointer;border:1px solid transparent;transition:all .15s;}
.p-item:hover{border-color:var(--border);}
.p-item.active{background:rgba(0,200,83,.1);border-color:var(--green);color:var(--green);}
.p-item .p-progress{font-size:.72rem;color:var(--muted);}
.p-item.active .p-progress{color:var(--green);}
.p-item.complete .p-name::after{content:' ‚úì';color:var(--green);}
.team-draft-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:1rem;}
.team-draft-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem;}
.team-draft-card h4{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1px;margin-bottom:.7rem;display:flex;align-items:center;justify-content:space-between;}
.team-abbr{font-size:.65rem;padding:.15rem .45rem;border-radius:4px;background:rgba(0,200,83,.12);color:var(--green);}
.player-pick-list{display:flex;flex-direction:column;gap:.28rem;max-height:190px;overflow-y:auto;}
.player-opt{display:flex;align-items:center;justify-content:space-between;padding:.32rem .6rem;border-radius:5px;font-size:.81rem;cursor:pointer;border:1px solid transparent;transition:all .12s;}
.player-opt:hover{background:rgba(0,200,83,.06);border-color:rgba(0,200,83,.2);}
.player-opt.disabled{opacity:.35;cursor:not-allowed;pointer-events:none;}
.player-opt.selected-by-me{background:rgba(0,200,83,.12);border-color:var(--green);color:var(--green);}
.draft-pips{display:flex;gap:2px;}
.mini-pip{width:7px;height:7px;border-radius:50%;background:var(--border);}
.mini-pip.filled{background:var(--green);}
.win-opt{display:flex;align-items:center;justify-content:space-between;padding:.5rem .9rem;border-radius:8px;font-size:.88rem;cursor:pointer;border:1px solid var(--border);background:var(--bg);transition:all .15s;margin-bottom:.4rem;}
.win-opt:hover{border-color:var(--gold);color:var(--gold);}
.win-opt.selected{background:rgba(255,214,0,.1);border-color:var(--gold);color:var(--gold);}
.win-opt.disabled{opacity:.35;cursor:not-allowed;}
.picks-summary{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.8rem;margin-top:1rem;}
.picks-summary h5{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:.6rem;}
.pick-row{display:flex;align-items:center;gap:.5rem;font-size:.8rem;padding:.2rem 0;}
.pick-row .team-tag{min-width:42px;font-size:.68rem;padding:.1rem .35rem;border-radius:3px;background:rgba(0,200,83,.1);color:var(--green);text-align:center;font-weight:600;}
.pick-row .no-pick{color:var(--muted);font-style:italic;}

/* REDRAFT */
.redraft-layout{display:grid;grid-template-columns:220px 1fr;gap:1.5rem;}
@media(max-width:700px){.redraft-layout{grid-template-columns:1fr;}}
.swap-slot-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:.8rem;}
.swap-slot-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:.9rem;}
.swap-slot-card h5{font-family:'Bebas Neue',sans-serif;font-size:.95rem;letter-spacing:1px;margin-bottom:.6rem;display:flex;align-items:center;justify-content:space-between;}
.current-player-row{display:flex;align-items:center;justify-content:space-between;background:rgba(0,200,83,.07);border:1px solid rgba(0,200,83,.18);border-radius:6px;padding:.45rem .7rem;margin-bottom:.5rem;}
.current-player-name{font-weight:600;font-size:.88rem;}
.frozen-pts{font-size:.72rem;color:var(--gold);}
.history-player-row{font-size:.75rem;color:var(--muted);padding:.15rem 0;display:flex;justify-content:space-between;}
.swap-select-wrap{display:flex;gap:.4rem;margin-top:.5rem;}
.swap-select-wrap select{flex:1;font-size:.8rem;}
.btn-swap{background:rgba(255,214,0,.15);border:1px solid rgba(255,214,0,.3);color:var(--gold);padding:.4rem .8rem;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-swap:hover{background:var(--gold);color:#000;}
.swap-log{display:flex;flex-direction:column;gap:.5rem;margin-top:.8rem;}
.swap-entry{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.7rem 1rem;font-size:.82rem;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;}
.swap-arrow{color:var(--gold);font-size:1rem;}
.swap-meta{color:var(--muted);font-size:.75rem;margin-left:auto;}

/* SCORING */
.import-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.5rem;position:relative;overflow:hidden;}
.import-box::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(0,200,83,.04) 0%,transparent 60%);pointer-events:none;}
.import-header{display:flex;align-items:center;gap:.6rem;margin-bottom:.7rem;}
.import-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1.5px;color:var(--green);}
.ai-badge{background:linear-gradient(135deg,var(--green),var(--gold));color:#000;font-size:.65rem;font-weight:700;padding:.15rem .5rem;border-radius:99px;letter-spacing:1px;text-transform:uppercase;}
.import-row{display:flex;gap:.6rem;}
.import-row input{flex:1;font-size:.85rem;width:auto;}
.btn-import{background:linear-gradient(135deg,var(--dark-green),var(--green));color:#000;border:none;padding:.6rem 1.2rem;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1.5px;cursor:pointer;transition:all .2s;white-space:nowrap;display:flex;align-items:center;gap:.4rem;}
.btn-import:hover{filter:brightness(1.15);transform:translateY(-1px);}
.btn-import:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.import-status{margin-top:.6rem;font-size:.82rem;min-height:1.1rem;display:flex;align-items:center;gap:.5rem;}
.status-loading{color:var(--gold);}.status-success{color:var(--green);}.status-error{color:var(--red);}
.spinner{width:14px;height:14px;border:2px solid rgba(255,214,0,.3);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
.import-preview{margin-top:1rem;display:none;}.import-preview.show{display:block;}
.preview-title{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:.5rem;}
.preview-player-row{display:flex;align-items:center;justify-content:space-between;padding:.35rem .65rem;border-radius:6px;font-size:.8rem;margin-bottom:.3rem;}
.preview-player-row.hit{background:rgba(0,200,83,.08);border:1px solid rgba(0,200,83,.2);}
.preview-player-row.miss{background:rgba(255,23,68,.06);border:1px solid rgba(255,23,68,.15);color:var(--muted);}
.preview-stats{display:flex;gap:.7rem;font-size:.75rem;color:var(--muted);}
.preview-stats span{color:var(--text);}
.badge-found{font-size:.68rem;padding:.1rem .4rem;border-radius:3px;font-weight:600;background:rgba(0,200,83,.2);color:var(--green);}
.badge-miss{font-size:.68rem;padding:.1rem .4rem;border-radius:3px;font-weight:600;background:rgba(255,23,68,.15);color:var(--red);}
.result-row{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.8rem;}
.res-btn{flex:1;min-width:100px;background:var(--bg);border:2px solid var(--border);color:var(--muted);padding:.55rem .8rem;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:.9rem;cursor:pointer;transition:all .2s;text-align:center;}
.res-btn:hover{border-color:var(--gold);color:var(--gold);}
.res-btn.sel-t1{background:rgba(41,121,255,.15);border-color:#2979FF;color:#82b1ff;}
.res-btn.sel-t2{background:rgba(255,109,0,.15);border-color:#FF6D00;color:#ffab40;}
.res-btn.sel-draw{background:rgba(255,214,0,.1);border-color:var(--gold);color:var(--gold);}
.match-log{display:flex;flex-direction:column;gap:.6rem;margin-top:1rem;}
.match-entry{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:.9rem 1.1rem;}
.match-entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;}
.match-title-text{font-weight:600;font-size:.95rem;}
.match-date-text{font-size:.75rem;color:var(--muted);}
.match-result-chip{font-size:.75rem;padding:.15rem .55rem;border-radius:99px;font-weight:600;}
.chip-t1{background:rgba(41,121,255,.15);color:#82b1ff;}
.chip-t2{background:rgba(255,109,0,.15);color:#ffab40;}
.chip-draw{background:rgba(255,214,0,.1);color:var(--gold);}
.match-player-updates{display:flex;flex-wrap:wrap;gap:.35rem;}
.player-update-chip{font-size:.73rem;padding:.15rem .5rem;border-radius:5px;background:rgba(0,200,83,.08);border:1px solid rgba(0,200,83,.15);}

/* LEADERBOARD */
.lb-table{width:100%;border-collapse:separate;border-spacing:0 .4rem;}
.lb-table th{text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);padding:0 .9rem .4rem;}
.lb-table td{background:var(--card);padding:.85rem .9rem;font-size:.88rem;}
.lb-table tr td:first-child{border-radius:10px 0 0 10px;}
.lb-table tr td:last-child{border-radius:0 10px 10px 0;}
.rank-badge{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:var(--border);color:var(--muted);}
.rank-1{background:var(--gold);color:#000;}.rank-2{background:#b0bec5;color:#000;}.rank-3{background:#a1714b;color:#fff;}
.pts-big{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--green);}
.pts-breakdown{font-size:.72rem;color:var(--muted);margin-top:.1rem;}
.pts-gold{color:var(--gold);}
.picks-mini{font-size:.75rem;color:var(--muted);line-height:1.7;}
.picks-mini strong{color:var(--text);}
.detail-row td{background:rgba(19,34,19,.6);padding:.6rem 1rem;}
.detail-row{display:none;}
.detail-row.open{display:table-row;}
.detail-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.4rem;}
.detail-chip{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.35rem .6rem;font-size:.76rem;}
.detail-chip .dc-team{color:var(--muted);font-size:.68rem;}
.detail-chip .dc-pts{float:right;color:var(--gold);font-weight:600;}
</style>
</head>
<body>

<header>
  <div class="logo">‚ö° IPL 2026 Fantasy</div>
  <div class="tagline">Season-Long ¬∑ 16 Players ¬∑ 10 Teams ¬∑ Live Sync</div>
  <div>
    <span class="sync-status" id="syncStatus">
      <span class="sync-dot loading" id="syncDot"></span>
      <span id="syncText">Connecting‚Ä¶</span>
    </span>
  </div>
</header>

<nav>
  <button class="tab-btn active" onclick="showScreen('draft',this)">üéØ Draft</button>
  <button class="tab-btn" onclick="showScreen('redraft',this)">üîÑ Redraft / Swap</button>
  <button class="tab-btn" onclick="showScreen('scoring',this)">üìä Match Scoring</button>
  <button class="tab-btn" onclick="showScreen('leaderboard',this)">üèÜ Leaderboard</button>
  <button class="tab-btn" onclick="showScreen('settings',this)">‚öôÔ∏è Settings</button>
</nav>

<div class="container">

<!-- DRAFT -->
<div id="screen-draft" class="screen active">
  <div class="section-title">Season Draft</div>
  <div class="scoring-key">
    <div class="key-item"><span class="key-dot" style="background:var(--green)"></span>1 Run = 1 pt</div>
    <div class="key-item"><span class="key-dot" style="background:var(--red)"></span>1 Wicket = 25 pts</div>
    <div class="key-item"><span class="key-dot" style="background:var(--gold)"></span>1 Catch = 5 pts</div>
    <div class="key-item"><span class="key-dot" style="background:#ff9800"></span>1 Run-out = 5 pts (both fielders)</div>
    <div class="key-item"><span class="key-dot" style="background:var(--purple)"></span>1 Stumping = 5 pts</div>
    <div class="key-item"><span class="key-dot" style="background:var(--muted)"></span>Max 2 drafts per player ¬∑ Max 4 foreign per fantasy team</div>
    <div class="key-item"><span class="key-dot" style="background:var(--gold)"></span>Draft 1 IPL Team: Win = 30 pts ¬∑ Draw = 15 pts ¬∑ Max 2 drafts per team</div>
  </div>
  <div class="info-box">
    Each of the <strong>16 fantasy players</strong> picks <strong>1 player from each of the 10 IPL teams</strong> (10 picks total).
    Max <strong>4 foreign players</strong> per fantasy team. <strong>All picks sync automatically</strong> for everyone.
  </div>
  <div class="card" style="margin-bottom:1.2rem">
    <div style="display:flex;gap:.7rem;align-items:flex-end">
      <div class="input-group" style="flex:1">
        <label>Add Fantasy Participant</label>
        <input type="text" id="newPName" placeholder="e.g. Priya" onkeydown="if(event.key==='Enter')addParticipant()">
      </div>
      <button class="btn btn-sm" onclick="addParticipant()">+ Add</button>
      <span id="pCount" style="color:var(--muted);font-size:.82rem;white-space:nowrap;padding-bottom:.1rem">0/16</span>
    </div>
  </div>
  <div class="draft-layout">
    <div class="participant-sidebar">
      <div class="card">
        <div class="subsection" style="margin-top:0">Participants</div>
        <div class="participant-list" id="participantList"></div>
        <div style="font-size:.75rem;color:var(--muted)">Click a name to make their picks.</div>
      </div>
    </div>
    <div>
      <div id="draftActiveLabel" style="font-size:.88rem;color:var(--muted);margin-bottom:.8rem">‚Üê Select a participant to start drafting</div>
      <div class="team-draft-grid" id="teamDraftGrid"></div>
      <div class="picks-summary" id="picksSummary" style="display:none">
        <h5>Current Picks for <span id="picksSummaryName"></span> &nbsp; <span id="picksSummaryForeign" style="font-size:.75rem;color:var(--muted)"></span></h5>
        <div id="picksSummaryRows"></div>
        <div style="margin-top:.8rem"><button class="btn btn-sm" onclick="savePicks()">üíæ Save Picks</button></div>
      </div>
    </div>
  </div>
</div>

<!-- REDRAFT -->
<div id="screen-redraft" class="screen">
  <div class="section-title">Redraft / Swap Players</div>
  <div class="info-box">
    Mid-season player swap or injury replacement. <strong>Frozen points from the old player remain.</strong>
    The new player earns points from their next match onwards. Swaps stay within the same IPL team. Max 2 drafts per player applies. You can also swap your <strong>drafted IPL team</strong> here.
  </div>
  <div class="redraft-layout">
    <div>
      <div class="card" style="position:sticky;top:1rem">
        <div class="subsection" style="margin-top:0">Select Participant</div>
        <div id="redraftParticipantList" class="participant-list"></div>
      </div>
    </div>
    <div>
      <div id="redraftActiveLabel" style="font-size:.88rem;color:var(--muted);margin-bottom:.8rem">‚Üê Select a participant to manage their picks</div>
      <div id="swapSlotGrid" class="swap-slot-grid"></div>
      <div id="swapHistorySection" style="display:none;margin-top:1.5rem">
        <div class="subsection">Swap History</div>
        <div id="swapLog" class="swap-log"></div>
      </div>
    </div>
  </div>
</div>

<!-- MATCH SCORING -->
<div id="screen-scoring" class="screen">
  <div class="section-title">Match Scoring</div>
  <div class="info-box">Paste a scorecard link for today's match. Claude will read it and update all drafted players' season totals automatically.</div>
  <div class="import-box">
    <div class="import-header">
      <span class="import-title">‚ö° Import Match Scorecard</span>
      <span class="ai-badge">AI Powered</span>
    </div>
    <div style="font-size:.82rem;color:var(--muted);margin-bottom:.8rem">
      Open the ESPNcricinfo scorecard page ‚Üí select all text (Ctrl+A) ‚Üí copy (Ctrl+C) ‚Üí paste below.
      <br>Tip: You can also just copy the batting + bowling tables section for cleaner results.
    </div>
    <div class="import-row" style="flex-direction:column;gap:.6rem">
      <textarea id="scorecardText" rows="8" placeholder="Paste scorecard text here‚Ä¶" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:.7rem;border-radius:8px;font-family:monospace;font-size:.78rem;resize:vertical;line-height:1.5"></textarea>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn-import" id="importBtn" onclick="importScorecard()"><span id="importIcon">üìã</span> Parse & Import</button>
      </div>
    </div>
    <div style="margin-top:.9rem">
      <label>Match Result</label>
      <div class="result-row">
        <button class="res-btn" id="res-t1" onclick="setPendingResult('t1')">‚Äî Team 1 Won</button>
        <button class="res-btn" id="res-draw" onclick="setPendingResult('draw')">ü§ù Draw / No Result</button>
        <button class="res-btn" id="res-t2" onclick="setPendingResult('t2')">‚Äî Team 2 Won</button>
      </div>
    </div>
    <div class="import-status" id="importStatus"></div>
    <div class="import-preview" id="importPreview">
      <div class="preview-title">Players found in draft ‚Äî <span id="previewCount"></span></div>
      <div id="previewList"></div>
      <div style="margin-top:.9rem" class="btn-row">
        <button class="btn btn-sm" onclick="applyMatch()">‚úÖ Apply to Season</button>
        <span style="font-size:.8rem;color:var(--muted)" id="applyNote"></span>
      </div>
    </div>
  </div>
  <div class="subsection">Match History</div>
  <div id="matchLog" class="match-log"><div class="empty-state">No matches scored yet.</div></div>
</div>

<!-- LEADERBOARD -->
<div id="screen-leaderboard" class="screen">
  <div class="section-title">üèÜ Season Leaderboard</div>
  <div id="leaderboardContent"><div class="empty-state">Complete the draft first.</div></div>
</div>

<!-- SETTINGS -->
<div id="screen-settings" class="screen">
  <div class="section-title">‚öôÔ∏è Settings</div>

  <!-- Import Squads -->
  <div class="card" style="margin-bottom:1.5rem">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem">
      <div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:1.5px;color:var(--green);margin-bottom:.4rem">üìã Import IPL Squads</div>
        <div style="font-size:.85rem;color:var(--muted);max-width:540px">Re-imports the IPL 2026 squad data from the app into Supabase for reference. Useful if squads are updated mid-season or a new season begins. This does <strong style="color:var(--text)">not</strong> affect any existing draft picks or scores.</div>
        <div id="importSquadsStatus" style="margin-top:.6rem;font-size:.82rem;min-height:1rem"></div>
      </div>
      <button class="btn" onclick="importSquads()" id="importSquadsBtn" style="white-space:nowrap;align-self:center">üìã Import Squads</button>
    </div>
  </div>

  <!-- Reset Everything -->
  <div class="card" style="border-color:rgba(255,23,68,.3);background:rgba(255,23,68,.04)">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem">
      <div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:1.5px;color:var(--red);margin-bottom:.4rem">üóëÔ∏è Reset Everything</div>
        <div style="font-size:.85rem;color:var(--muted);max-width:540px">
          Permanently wipes <strong style="color:var(--text)">all data</strong> from Supabase ‚Äî participants, picks, scores, match history, swaps, and settings. Use this to clear test data before the real season, or to start a fresh league.
        </div>
        <div style="margin-top:.5rem;font-size:.8rem;color:var(--red)">‚ö†Ô∏è This cannot be undone.</div>
        <div id="resetStatus" style="margin-top:.6rem;font-size:.82rem;min-height:1rem"></div>
      </div>
      <button class="btn" onclick="resetEverything()" id="resetBtn"
        style="background:var(--red);white-space:nowrap;align-self:center;color:#fff">
        üóëÔ∏è Reset Everything
      </button>
    </div>
  </div>
</div>

</div><!-- /container -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://oecyxuygrhtdnypmunae.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lY3l4dXlncmh0ZG55cG11bmFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzg5OTYsImV4cCI6MjA4Njk1NDk5Nn0.bHzTsY59yXshCZ_VSGK1W7iVzhn3GJQcBfby9XWSt80';
// Anthropic API key is stored securely in Netlify environment variables.
// All AI calls go through /.netlify/functions/anthropic (server-side proxy).

async function sb(method, table, body=null, params='', extraHeaders={}) {
  const url = `${SUPABASE_URL}/rest/v1/${table}${params}`;
  const opts = {
    method,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation',
      ...extraHeaders
    }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`${method} ${table}: ${err}`);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

// Convenience wrappers
const dbGet = (table, params='') => sb('GET', table, null, params);
const dbPost = (table, body) => sb('POST', table, body);
const dbPatch = (table, body, params) => sb('PATCH', table, body, params);
const dbDelete = (table, params) => sb('DELETE', table, null, params);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IPL 2026 SQUADS ‚Äî loaded from Supabase, seeded on first run
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Fallback seed data used to populate Supabase if squads table is empty
const SQUAD_SEED = [
  {team_key:'CSK',team_name:'Chennai Super Kings',player_name:'MS Dhoni',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Ruturaj Gaikwad',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Sanju Samson',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Ayush Mhatre',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Dewald Brevis',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Shivam Dube',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Urvil Patel',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Noor Ahmad',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Nathan Ellis',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Shreyas Gopal',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Khaleel Ahmed',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Ramakrishna Ghosh',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Mukesh Choudhary',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Jamie Overton',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Gurjapneet Singh',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Anshul Kamboj',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Prashant Veer',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Kartik Sharma',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Rahul Chahar',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Akeal Hosein',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Matt Henry',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Matthew Short',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Sarfaraz Khan',is_foreign:false},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Zak Foulkes',is_foreign:true},{team_key:'CSK',team_name:'Chennai Super Kings',player_name:'Aman Khan',is_foreign:false},
  {team_key:'DC',team_name:'Delhi Capitals',player_name:'KL Rahul',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Axar Patel',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Kuldeep Yadav',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Mitchell Starc',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Tristan Stubbs',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Abhishek Porel',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Karun Nair',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Nitish Rana',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Ashutosh Sharma',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'T Natarajan',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Mukesh Kumar',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Sameer Rizvi',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Vipraj Nigam',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Tripurana Vijay',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Dushmantha Chameera',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Madhav Tiwari',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Ajay Mandal',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Auqib Nabi Dar',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Pathum Nissanka',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'David Miller',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Ben Duckett',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Lungi Ngidi',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Kyle Jamieson',is_foreign:true},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Prithvi Shaw',is_foreign:false},{team_key:'DC',team_name:'Delhi Capitals',player_name:'Sahil Parikh',is_foreign:false},
  {team_key:'GT',team_name:'Gujarat Titans',player_name:'Shubman Gill',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Sai Sudharsan',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Rashid Khan',is_foreign:true},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Jos Buttler',is_foreign:true},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Glenn Phillips',is_foreign:true},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Rahul Tewatia',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Shahrukh Khan',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Kagiso Rabada',is_foreign:true},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Mohammed Siraj',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Washington Sundar',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Prasidh Krishna',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'R Sai Kishore',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Nishant Sindhu',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Kumar Kushagra',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Anuj Rawat',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Manav Suthar',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Jayant Yadav',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Gurnoor Brar',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Ishant Sharma',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Arshad Khan',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Jason Holder',is_foreign:true},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Tom Banton',is_foreign:true},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Ashok Sharma',is_foreign:false},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Luke Wood',is_foreign:true},{team_key:'GT',team_name:'Gujarat Titans',player_name:'Prithvi Raj',is_foreign:false},
  {team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Ajinkya Rahane',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Sunil Narine',is_foreign:true},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Varun Chakravarthy',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Rinku Singh',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Angkrish Raghuvanshi',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Rovman Powell',is_foreign:true},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Ramandeep Singh',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Harshit Rana',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Vaibhav Arora',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Umran Malik',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Anukul Roy',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Manish Pandey',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Cameron Green',is_foreign:true},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Matheesha Pathirana',is_foreign:true},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Finn Allen',is_foreign:true},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Rachin Ravindra',is_foreign:true},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Tim Seifert',is_foreign:true},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Akash Deep',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Rahul Tripathi',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Tejasvi Singh',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Daksh Kamra',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Sarthak Ranjan',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Prashant Solanki',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Kartik Tyagi',is_foreign:false},{team_key:'KKR',team_name:'Kolkata Knight Riders',player_name:'Mustafizur Rahman',is_foreign:true},
  {team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Rishabh Pant',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Aiden Markram',is_foreign:true},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Mitchell Marsh',is_foreign:true},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Nicholas Pooran',is_foreign:true},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Ayush Badoni',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Abdul Samad',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Mayank Yadav',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Mohammed Shami',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Avesh Khan',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Shahbaz Ahmed',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Mohsin Khan',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Digvesh Rathi',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Arshin Kulkarni',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Himmat Singh',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Manimaran Siddharth',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Matthew Breetzke',is_foreign:true},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Akash Singh',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Arjun Tendulkar',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Wanindu Hasaranga',is_foreign:true},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Josh Inglis',is_foreign:true},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Anrich Nortje',is_foreign:true},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Mukul Choudhary',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Akshat Raghuwanshi',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Naman Tiwari',is_foreign:false},{team_key:'LSG',team_name:'Lucknow Super Giants',player_name:'Prince Yadav',is_foreign:false},
  {team_key:'MI',team_name:'Mumbai Indians',player_name:'Rohit Sharma',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Suryakumar Yadav',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Hardik Pandya',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Jasprit Bumrah',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Tilak Varma',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Naman Dhir',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Raj Angad Bawa',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Robin Minz',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Ryan Rickelton',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Quinton de Kock',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Shardul Thakur',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Sherfane Rutherford',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Corbin Bosch',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Mitchell Santner',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Will Jacks',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Atharva Ankolekar',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Mayank Markande',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Allah Ghazanfar',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Raghu Sharma',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Ashwani Kumar',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Deepak Chahar',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Trent Boult',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Romario Shepherd',is_foreign:true},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Danish Malewar',is_foreign:false},{team_key:'MI',team_name:'Mumbai Indians',player_name:'Bevon Jacobs',is_foreign:true},
  {team_key:'PBKS',team_name:'Punjab Kings',player_name:'Shreyas Iyer',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Priyansh Arya',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Prabhsimran Singh',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Nehal Wadhera',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Shashank Singh',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Arshdeep Singh',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Yuzvendra Chahal',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Marco Jansen',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Marcus Stoinis',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Azmatullah Omarzai',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Lockie Ferguson',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Harpreet Brar',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Vyshak Vijaykumar',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Yash Thakur',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Cooper Connolly',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Ben Dwarshuis',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Mitchell Owen',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Vishnu Vinod',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Harnoor Pannu',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Musheer Khan',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Pyla Avinash',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Suryansh Shedge',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Xavier Bartlett',is_foreign:true},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Pravin Dubey',is_foreign:false},{team_key:'PBKS',team_name:'Punjab Kings',player_name:'Vishal Nishad',is_foreign:false},
  {team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Virat Kohli',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Rajat Patidar',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Devdutt Padikkal',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Phil Salt',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Jitesh Sharma',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Krunal Pandya',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Tim David',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Venkatesh Iyer',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Jacob Bethell',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Josh Hazlewood',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Yash Dayal',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Bhuvneshwar Kumar',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Nuwan Thushara',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Rasikh Salam',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Swapnil Singh',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Suyash Sharma',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Satwik Deswal',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Mangesh Yadav',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Jordan Cox',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Vicky Ostwal',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Kanishk Chouhan',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Vihaan Malhotra',is_foreign:false},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Jacob Duffy',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Romario Shepherd',is_foreign:true},{team_key:'RCB',team_name:'Royal Challengers Bengaluru',player_name:'Abhinandan Singh',is_foreign:false},
  {team_key:'RR',team_name:'Rajasthan Royals',player_name:'Yashasvi Jaiswal',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Vaibhav Suryavanshi',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Riyan Parag',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Ravindra Jadeja',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Sam Curran',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Dhruv Jurel',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Shimron Hetmyer',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Jofra Archer',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Ravi Bishnoi',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Sandeep Sharma',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Nandre Burger',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Kwena Maphaka',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Shubham Dubey',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Donovan Ferreira',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Yudhvir Singh Charak',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Lhuan-dre Pretorius',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Ravi Singh',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Brijesh Sharma',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Adam Milne',is_foreign:true},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Sushant Mishra',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Aman Rao Perala',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Vignesh Puthur',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Yash Raj Punja',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Kuldeep Sen',is_foreign:false},{team_key:'RR',team_name:'Rajasthan Royals',player_name:'Tushar Deshpande',is_foreign:false},
  {team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Pat Cummins',is_foreign:true},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Travis Head',is_foreign:true},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Heinrich Klaasen',is_foreign:true},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Abhishek Sharma',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Nitish Kumar Reddy',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Ishan Kishan',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Aniket Verma',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Brydon Carse',is_foreign:true},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Harshal Patel',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Kamindu Mendis',is_foreign:true},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Liam Livingstone',is_foreign:true},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Jaydev Unadkat',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Shivam Mavi',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Jack Edwards',is_foreign:true},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Harsh Dubey',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Salil Arora',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Smaran Ravichandran',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Zeeshan Ansari',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Amit Kumar',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Eshan Malinga',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Shivang Kumar',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Praful Hinge',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Onkar Tarmale',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Sakib Hussain',is_foreign:false},{team_key:'SRH',team_name:'Sunrisers Hyderabad',player_name:'Simarjeet Singh',is_foreign:false}
];

// IPL_TEAMS is built dynamically from Supabase squads on load
let IPL_TEAMS = {};
let TEAM_KEYS = [];

function buildIPLTeamsFromRows(rows) {
  const teams = {};
  rows.forEach(r => {
    if (!teams[r.team_key]) teams[r.team_key] = { name: r.team_name, players: [] };
    teams[r.team_key].players.push({ name: r.player_name, foreign: r.is_foreign });
  });
  return teams;
}

const MAX_PLAYER_DRAFTS = 2;
const MAX_FOREIGN_PER_FANTASY = 4;
const MAX_TEAM_DRAFTS = 2;
const TEAM_WIN_PTS = 30;
const TEAM_DRAW_PTS = 15;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL STATE (populated from DB on load)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  participants: [],   // [{id, name, picks:{CSK:'Player',...}, pickHistory:{CSK:['Old'...]}, teamPick:'MI'}]
  seasonScores: {},   // player_name -> {runs,wickets,catches,runouts,stumpings}
  teamWins: {},       // team_key -> {wins, draws}
  matchHistory: [],
  swapHistory: [],
  activeParticipant: null,
  activeRedraftParticipant: null,
  pendingImport: null,
  pendingResult: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNC STATUS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSyncStatus(state, msg) {
  const dot = document.getElementById('syncDot');
  const text = document.getElementById('syncText');
  dot.className = `sync-dot ${state}`;
  text.textContent = msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD ALL DATA FROM SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAll() {
  setSyncStatus('loading', 'Syncing‚Ä¶');
  try {
    // Load squads first ‚Äî seed from SQUAD_SEED if table is empty
    let squadRows = await dbGet('squads', '?order=team_key.asc,player_name.asc');
    if (!squadRows || squadRows.length === 0) {
      // First run ‚Äî seed the squads table in batches
      for (let i = 0; i < SQUAD_SEED.length; i += 50) {
        await sb('POST', 'squads', SQUAD_SEED.slice(i, i + 50), '', { 'Prefer': 'return=minimal' });
      }
      squadRows = SQUAD_SEED;
    }
    IPL_TEAMS = buildIPLTeamsFromRows(squadRows);
    TEAM_KEYS.length = 0;
    Object.keys(IPL_TEAMS).sort().forEach(k => TEAM_KEYS.push(k));
    const [participants, picks, scores, matches, swaps] = await Promise.all([
      dbGet('participants', '?order=created_at.asc'),
      dbGet('picks', '?order=created_at.asc'),
      dbGet('season_scores', ''),
      dbGet('match_history', '?order=created_at.asc'),
      dbGet('swap_history', '?order=created_at.asc'),
    ]);

    state.participants = (participants||[]).map(p => {
      const myPicks = (picks||[]).filter(pk => pk.participant_id === p.id);
      const activePicks = {}, pickHistory = {};
      myPicks.forEach(pk => {
        if (pk.is_active) activePicks[pk.team_key] = pk.player_name;
        else {
          if (!pickHistory[pk.team_key]) pickHistory[pk.team_key] = [];
          pickHistory[pk.team_key].push(pk.player_name);
        }
      });
      return { id: p.id, name: p.name, picks: activePicks, pickHistory, teamPick: p.team_pick||null };
    });

    state.seasonScores = {};
    (scores||[]).forEach(s => {
      state.seasonScores[s.player_name] = { runs:s.runs, wickets:s.wickets, catches:s.catches, runouts:s.runouts||0 };
    });

    state.matchHistory = (matches||[]).map(m => ({
      id:m.id, title:m.title, date:m.match_date,
      result:m.result, t1name:m.t1_name, t2name:m.t2_name, updates:m.updates||[]
    }));

    // Recompute teamWins from full match history
    state.teamWins = {};
    state.matchHistory.forEach(m => applyMatchResultToTeamWins(m, false));

    state.swapHistory = (swaps||[]).map(s => ({
      id:s.id, participantName:s.participant_name, teamKey:s.team_key,
      teamName:s.team_name, oldPlayer:s.old_player, newPlayer:s.new_player,
      frozenPts:s.frozen_pts, date:s.swap_date
    }));

    setSyncStatus('ok', 'Synced');
    renderAll();
  } catch(e) {
    console.error(e);
    setSyncStatus('err', 'Sync failed ‚Äî check console');
  }
}

function renderAll() {
  renderParticipantList();
  renderDraftGrid();
  renderPicksSummary();
  renderRedraftScreen();
  renderMatchLog();
  renderLeaderboard();
}

// Auto-refresh every 30 seconds so all viewers stay in sync
setInterval(loadAll, 30000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAFT COUNTS (from local state)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDraftCounts() {
  const pc = {}, tc = {};
  state.participants.forEach(p => {
    TEAM_KEYS.forEach(k => {
      if (p.picks[k]) pc[p.picks[k]] = (pc[p.picks[k]]||0)+1;
      (p.pickHistory?.[k]||[]).forEach(name => { pc[name] = (pc[name]||0)+1; });
    });
    if (p.teamPick) tc[p.teamPick] = (tc[p.teamPick]||0)+1;
  });
  return { pc, tc };
}

// Count foreign players in a participant's current active picks
function countForeignPicks(participant, excludeTeamKey=null) {
  let count = 0;
  TEAM_KEYS.forEach(k => {
    if (k === excludeTeamKey) return;
    const pick = participant.picks[k];
    if (!pick) return;
    const playerObj = (IPL_TEAMS[k]?.players||[]).find(p => p.name === pick);
    if (playerObj?.foreign) count++;
  });
  return count;
}


async function addParticipant() {
  if (state.participants.length >= 16) { alert('Max 16 participants!'); return; }
  const name = document.getElementById('newPName').value.trim();
  if (!name) return;
  if (state.participants.find(p => p.name.toLowerCase()===name.toLowerCase())) { alert('Name already exists'); return; }
  try {
    setSyncStatus('loading','Saving‚Ä¶');
    const [row] = await dbPost('participants', { name });
    state.participants.push({ id: row.id, name, winPick: null, picks: {}, pickHistory: {} });
    document.getElementById('newPName').value = '';
    setSyncStatus('ok','Synced');
    renderParticipantList();
    setActiveParticipant(state.participants.length-1);
  } catch(e) { setSyncStatus('err','Save failed'); alert(e.message); }
}

function renderParticipantList() {
  document.getElementById('pCount').textContent = `${state.participants.length}/16`;
  const el = document.getElementById('participantList');
  if (!state.participants.length) { el.innerHTML='<div class="empty-state" style="padding:.5rem">No participants yet.</div>'; return; }
  el.innerHTML = state.participants.map((p,i) => {
    const pickCount = TEAM_KEYS.filter(k=>p.picks[k]).length;
    const complete = pickCount===10;
    const active = state.activeParticipant===i;
    return `<div class="p-item ${active?'active':''} ${complete?'complete':''}" onclick="setActiveParticipant(${i})">
      <span class="p-name">${p.name}</span>
      <span class="p-progress">${pickCount}/10</span>
    </div>`;
  }).join('');
}

function setActiveParticipant(i) {
  state.activeParticipant = i;
  renderParticipantList();
  renderDraftGrid();
  renderPicksSummary();
  document.getElementById('draftActiveLabel').innerHTML =
    `Drafting for <strong style="color:var(--green)">${state.participants[i].name}</strong>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAFT GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDraftGrid() {
  const {pc} = getDraftCounts();
  const ai = state.activeParticipant;
  const active = ai!==null ? state.participants[ai] : null;
  const foreignCount = active ? countForeignPicks(active) : 0;

  document.getElementById('teamDraftGrid').innerHTML = TEAM_KEYS.map(key => {
    const team = IPL_TEAMS[key];
    const myPickName = active ? active.picks[key] : null;
    // Foreign count excluding this slot (so we can show if picking this slot's foreign would breach limit)
    const foreignExcludingSlot = active ? countForeignPicks(active, key) : 0;

    const rows = team.players.map(playerObj => {
      const {name: player, foreign} = playerObj;
      const count = pc[player]||0;
      const full = count>=MAX_PLAYER_DRAFTS;
      const isMe = myPickName===player;
      const wouldBreachForeign = foreign && !isMe && foreignExcludingSlot >= MAX_FOREIGN_PER_FANTASY;
      const disabled = !active || (full&&!isMe) || wouldBreachForeign;
      const flag = foreign ? 'üåç' : 'üáÆüá≥';
      const foreignTag = foreign
        ? `<span style="font-size:.65rem;background:rgba(255,152,0,.15);color:#ff9800;border-radius:3px;padding:.05rem .3rem">OVS</span>`
        : '';
      return `<div class="player-opt ${disabled?'disabled':''} ${isMe?'selected-by-me':''}"
          onclick="${disabled?'':`togglePlayerPick('${key}','${player.replace(/'/g,"\\'")}')` }" title="${wouldBreachForeign?'Foreign player limit reached (max 4)':''}">
        <span>${flag} ${player} ${foreignTag}</span>
        <span style="display:flex;align-items:center;gap:4px">
          <span class="draft-pips">${[0,1].map(j=>`<span class="mini-pip ${j<count?'filled':''}"></span>`).join('')}</span>
          ${isMe?'<span style="font-size:.9rem">‚úì</span>':''}
        </span>
      </div>`;
    }).join('');

    return `<div class="team-draft-card">
      <h4>${team.name} <span class="team-abbr">${key}</span></h4>
      <div class="player-pick-list">${rows}</div>
    </div>`;
  }).join('');

  // Team pick card ‚Äî appended after all player cards
  const {tc} = getDraftCounts();
  const myTeamPick = active ? active.teamPick : null;
  const teamCardRows = TEAM_KEYS.map(key => {
    const count = tc[key]||0;
    const full = count >= MAX_TEAM_DRAFTS;
    const isMe = myTeamPick === key;
    const disabled = !active || (full && !isMe);
    const wins = state.teamWins[key]?.wins||0;
    const draws = state.teamWins[key]?.draws||0;
    const earnedPts = wins*TEAM_WIN_PTS + draws*TEAM_DRAW_PTS;
    return `<div class="player-opt ${disabled?'disabled':''} ${isMe?'selected-by-me':''}"
        onclick="${disabled?'':`toggleTeamPick('${key}')`}" title="${full&&!isMe?'Team already drafted '+MAX_TEAM_DRAFTS+' times':''}">
      <span>üèè ${IPL_TEAMS[key].name} <span style="font-size:.65rem;background:rgba(0,200,83,.12);color:var(--green);border-radius:3px;padding:.05rem .3rem">${key}</span></span>
      <span style="display:flex;align-items:center;gap:4px">
        <span style="font-size:.7rem;color:var(--muted)">${earnedPts?earnedPts+'pts':''}</span>
        <span class="draft-pips">${[0,1].map(j=>`<span class="mini-pip ${j<count?'filled':''}" style="${isMe&&j===0?'background:#FFD600':''}""></span>`).join('')}</span>
        ${isMe?'<span style="font-size:.9rem">‚úì</span>':''}
      </span>
    </div>`;
  }).join('');

  // Append team card to grid
  const teamCard = `<div class="team-draft-card" style="border-color:rgba(255,214,0,.3);background:rgba(255,214,0,.04)">
    <h4 style="color:var(--gold)">üèÜ Draft a Team <span class="team-abbr" style="background:rgba(255,214,0,.15);color:var(--gold)">+30 pts/win</span></h4>
    <div style="font-size:.72rem;color:var(--muted);margin-bottom:.5rem">Each IPL team win = 30 pts ¬∑ Draw = 15 pts ¬∑ Max 2 drafts per team</div>
    <div class="player-pick-list">${teamCardRows}</div>
  </div>`;
  document.getElementById('teamDraftGrid').innerHTML += teamCard;

  // Foreign counter badge for active participant
  if (active) {
    const existing = document.getElementById('foreignCounter');
    const badge = `<div id="foreignCounter" style="margin-bottom:.8rem;display:flex;align-items:center;gap:.6rem">
      <span style="font-size:.82rem;color:var(--muted)">Foreign players in your team:</span>
      <span style="font-weight:600;color:${foreignCount>=MAX_FOREIGN_PER_FANTASY?'#ff9800':'var(--green)'}">
        ${foreignCount} / ${MAX_FOREIGN_PER_FANTASY}
      </span>
      ${foreignCount>=MAX_FOREIGN_PER_FANTASY?'<span style="font-size:.75rem;color:#ff9800">‚ö† Limit reached</span>':''}
    </div>`;
    if (existing) existing.outerHTML = badge;
    else document.getElementById('draftActiveLabel').insertAdjacentHTML('afterend', badge);
  } else {
    const existing = document.getElementById('foreignCounter');
    if (existing) existing.remove();
  }
}


async function togglePlayerPick(teamKey, player) {
  const ai = state.activeParticipant;
  if (ai===null) return;
  const p = state.participants[ai];
  const {pc} = getDraftCounts();
  const isDeselect = p.picks[teamKey]===player;

  if (!isDeselect && (pc[player]||0)>=MAX_PLAYER_DRAFTS) { alert(`${player} is already drafted ${MAX_PLAYER_DRAFTS} times!`); return; }

  // Check foreign player limit (exclude this slot since it's being replaced)
  if (!isDeselect) {
    const playerObj = (IPL_TEAMS[teamKey]?.players||[]).find(pl => pl.name === player);
    if (playerObj?.foreign && countForeignPicks(p, teamKey) >= MAX_FOREIGN_PER_FANTASY) {
      alert(`Max ${MAX_FOREIGN_PER_FANTASY} foreign players per fantasy team! Choose an Indian player instead.`);
      return;
    }
  }

  try {
    setSyncStatus('loading','Saving‚Ä¶');
    if (isDeselect) {
      await dbDelete('picks', `?participant_id=eq.${p.id}&team_key=eq.${teamKey}&is_active=eq.true`);
      delete p.picks[teamKey];
    } else {
      if (p.picks[teamKey]) {
        await dbDelete('picks', `?participant_id=eq.${p.id}&team_key=eq.${teamKey}&is_active=eq.true`);
      }
      await dbPost('picks', { participant_id: p.id, team_key: teamKey, player_name: player, is_active: true });
      p.picks[teamKey] = player;
    }
    setSyncStatus('ok','Synced');
  } catch(e) { setSyncStatus('err','Save failed'); console.error(e); return; }

  // Only re-render if this participant is still active (user may have switched)
  if (state.activeParticipant === ai) {
    renderDraftGrid();
    renderPicksSummary();
    renderParticipantList();
  } else {
    // Still update participant list progress counts
    renderParticipantList();
  }
}

async function toggleTeamPick(teamKey) {
  const ai = state.activeParticipant;
  if (ai===null) return;
  const p = state.participants[ai];
  const {tc} = getDraftCounts();
  const isDeselect = p.teamPick === teamKey;

  if (!isDeselect && (tc[teamKey]||0) >= MAX_TEAM_DRAFTS) {
    alert(`${IPL_TEAMS[teamKey].name} has already been drafted ${MAX_TEAM_DRAFTS} times!`); return;
  }

  try {
    setSyncStatus('loading','Saving‚Ä¶');
    const newVal = isDeselect ? null : teamKey;
    await dbPatch('participants', { team_pick: newVal }, `?id=eq.${p.id}`);
    p.teamPick = newVal;
    setSyncStatus('ok','Synced');
  } catch(e) { setSyncStatus('err','Save failed'); console.error(e); return; }

  if (state.activeParticipant === ai) {
    renderDraftGrid();
    renderPicksSummary();
    renderParticipantList();
  } else {
    renderParticipantList();
  }
}

// Apply a match result to teamWins state (additive or subtractive)
function applyMatchResultToTeamWins(m, add=true) {
  const delta = add ? 1 : -1;
  if (!m.t1name || !m.t2name) return;
  // Find team keys from names
  const findKey = name => TEAM_KEYS.find(k => IPL_TEAMS[k]?.name?.toLowerCase() === name?.toLowerCase());
  const t1key = findKey(m.t1name);
  const t2key = findKey(m.t2name);
  if (!state.teamWins[t1key]) state.teamWins[t1key] = {wins:0,draws:0};
  if (!state.teamWins[t2key]) state.teamWins[t2key] = {wins:0,draws:0};
  if (m.result === 'draw') {
    if (t1key) state.teamWins[t1key].draws = Math.max(0, (state.teamWins[t1key]?.draws||0)+delta);
    if (t2key) state.teamWins[t2key].draws = Math.max(0, (state.teamWins[t2key]?.draws||0)+delta);
  } else if (m.result === 't1' && t1key) {
    state.teamWins[t1key].wins = Math.max(0, (state.teamWins[t1key]?.wins||0)+delta);
  } else if (m.result === 't2' && t2key) {
    state.teamWins[t2key].wins = Math.max(0, (state.teamWins[t2key]?.wins||0)+delta);
  }
}

function savePicks() {
  const ai = state.activeParticipant;
  if (ai===null) return;
  const p = state.participants[ai];
  const done = TEAM_KEYS.filter(k=>p.picks[k]).length;
  if (done<10) { alert(`${p.name} still needs ${10-done} more player pick(s).`); return; }
  alert(`‚úì All 10 picks saved for ${p.name}!`);
}

function renderPicksSummary() {
  const ai = state.activeParticipant;
  const el = document.getElementById('picksSummary');
  if (!el) return;
  if (ai===null) { el.style.display='none'; return; }
  el.style.display='block';
  const p = state.participants[ai];
  const foreignCount = countForeignPicks(p);

  // Update both the name span and foreign count together
  const nameEl = document.getElementById('picksSummaryName');
  if (nameEl) nameEl.textContent = p.name;

  const foreignEl = document.getElementById('picksSummaryForeign');
  if (foreignEl) {
    foreignEl.textContent = `üåç ${foreignCount}/${MAX_FOREIGN_PER_FANTASY} foreign`;
    foreignEl.style.color = foreignCount >= MAX_FOREIGN_PER_FANTASY ? '#ff9800' : 'var(--muted)';
  }

  const rows = TEAM_KEYS.map(k => {
    const pick = p.picks[k];
    const players = IPL_TEAMS[k]?.players || [];
    const playerObj = pick ? players.find(pl => pl.name === pick) : null;
    return `<div class="pick-row">
      <span class="team-tag">${k}</span>
      ${pick
        ? `<span>${playerObj?.foreign ? 'üåç' : 'üáÆüá≥'} ${pick}</span>`
        : `<span class="no-pick">not picked</span>`}
    </div>`;
  }).join('');

  const teamRow = `<div class="pick-row" style="border-top:1px solid var(--border);margin-top:.4rem;padding-top:.4rem">
    <span class="team-tag" style="background:rgba(255,214,0,.12);color:var(--gold)">TEAM</span>
    ${p.teamPick
      ? `<span>üèÜ ${IPL_TEAMS[p.teamPick]?.name||p.teamPick} <span style="font-size:.7rem;color:var(--muted)">(${p.teamPick})</span></span>`
      : `<span class="no-pick">no team picked</span>`}
  </div>`;
  document.getElementById('picksSummaryRows').innerHTML = rows + teamRow;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REDRAFT / SWAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRedraftScreen() {
  const listEl = document.getElementById('redraftParticipantList');
  if (!state.participants.length) { listEl.innerHTML='<div class="empty-state" style="padding:.5rem">No participants yet.</div>'; return; }
  listEl.innerHTML = state.participants.map((p,i) => {
    const active = state.activeRedraftParticipant===i;
    return `<div class="p-item ${active?'active':''}" onclick="setActiveRedraft(${i})">
      <span class="p-name">${p.name}</span>
    </div>`;
  }).join('');
  const grid = document.getElementById('swapSlotGrid');
  if (state.activeRedraftParticipant!==null) {
    renderSwapSlots();
  } else {
    if (grid) grid.innerHTML = '';
  }
  renderSwapHistory();
}

function setActiveRedraft(i) {
  state.activeRedraftParticipant = i;
  document.getElementById('redraftActiveLabel').innerHTML =
    `Managing picks for <strong style="color:var(--gold)">${state.participants[i].name}</strong>`;
  renderRedraftScreen();
}

function renderSwapSlots() {
  const ai = state.activeRedraftParticipant;
  if (ai===null) return;
  const p = state.participants[ai];
  const {pc} = getDraftCounts();

  document.getElementById('swapSlotGrid').innerHTML = TEAM_KEYS.map(key => {
    const team = IPL_TEAMS[key];
    const current = p.picks[key];
    const history = p.pickHistory?.[key]||[];
    const frozenPts = history.reduce((sum,name) => {
      const sc = state.seasonScores[name]||{runs:0,wickets:0,catches:0,runouts:0};
      return sum + sc.runs + sc.wickets*25 + sc.catches*5 + (sc.runouts||0)*5;
    }, 0);
    const curSc = current ? (state.seasonScores[current]||{runs:0,wickets:0,catches:0,runouts:0}) : null;
    const curPts = curSc ? curSc.runs+curSc.wickets*25+curSc.catches*5+(curSc.runouts||0)*5 : 0;

    const playerOpts = team.players.map(playerObj => {
      const {name: player, foreign} = playerObj;
      if (player===current) return '';
      const count = pc[player]||0;
      const full = count>=MAX_PLAYER_DRAFTS;
      // Foreign limit check for swap
      const foreignLimitReached = foreign && countForeignPicks(p, key) >= MAX_FOREIGN_PER_FANTASY;
      const disabled2 = full || foreignLimitReached;
      const flag = foreign ? 'üåç' : 'üáÆüá≥';
      if (foreignLimitReached) return ''; // Hide foreign options entirely when limit reached
      return `<option value="${player}" ${disabled2?'disabled':''}>${flag} ${player}${full?' (FULL)':count===1?' ¬∑1 left':''}</option>`;
    }).filter(Boolean).join('');

    const historyRows = history.map(name => {
      const sc = state.seasonScores[name]||{runs:0,wickets:0,catches:0,runouts:0};
      const pts = sc.runs+sc.wickets*25+sc.catches*5+(sc.runouts||0)*5;
      return `<div class="history-player-row"><span>‚Ü© ${name}</span><span>${pts} pts frozen</span></div>`;
    }).join('');

    return `<div class="swap-slot-card">
      <h5>${key} <span style="font-size:.7rem;color:var(--muted)">${team.name}</span></h5>
      ${history.length ? `<div style="margin-bottom:.4rem">${historyRows}</div>` : ''}
      <div class="current-player-row">
        <span class="current-player-name">${current||'‚Äî not picked ‚Äî'}</span>
        <span class="frozen-pts">${current?curPts+' pts':''}</span>
      </div>
      ${history.length ? `<div style="font-size:.72rem;color:var(--muted);margin-bottom:.4rem">+ ${frozenPts} frozen pts from prev.</div>` : ''}
      <div class="swap-select-wrap">
        <select id="swapSel_${key}">
          <option value="">‚Äî ${current?'swap to':'pick'} player‚Ä¶ ‚Äî</option>
          ${playerOpts}
        </select>
        <button class="btn-swap" onclick="executeSwap(${ai},'${key}')">${current?'Swap':'Pick'}</button>
      </div>
    </div>`;
  }).join('');

  // Team pick swap card
  const {tc} = getDraftCounts();
  const myTeam = p.teamPick;
  const teamOpts = TEAM_KEYS.map(k => {
    if (k === myTeam) return '';
    const count = tc[k]||0;
    const full = count >= MAX_TEAM_DRAFTS;
    const wins = state.teamWins[k]?.wins||0;
    const draws = state.teamWins[k]?.draws||0;
    return `<option value="${k}" ${full?'disabled':''}>${IPL_TEAMS[k].name} (${k})${full?' ‚Äî FULL':''}  ${wins}W ${draws}D</option>`;
  }).filter(Boolean).join('');

  const teamWins = myTeam ? (state.teamWins[myTeam]?.wins||0) : 0;
  const teamDraws = myTeam ? (state.teamWins[myTeam]?.draws||0) : 0;
  const teamPts = teamWins*TEAM_WIN_PTS + teamDraws*TEAM_DRAW_PTS;

  document.getElementById('swapSlotGrid').innerHTML += `<div class="swap-slot-card" style="border-color:rgba(255,214,0,.3);background:rgba(255,214,0,.04)">
    <h5 style="color:var(--gold)">üèÜ <span style="font-size:.7rem;color:var(--muted)">Team Draft</span></h5>
    <div class="current-player-row" style="background:rgba(255,214,0,.07);border-color:rgba(255,214,0,.2)">
      <span class="current-player-name">${myTeam ? IPL_TEAMS[myTeam]?.name+' ('+myTeam+')' : '‚Äî not picked ‚Äî'}</span>
      <span class="frozen-pts">${myTeam ? teamPts+' pts ('+teamWins+'W '+teamDraws+'D)' : ''}</span>
    </div>
    <div class="swap-select-wrap">
      <select id="swapSel_TEAM">
        <option value="">‚Äî ${myTeam?'swap to':'pick a'} team‚Ä¶ ‚Äî</option>
        ${teamOpts}
      </select>
      <button class="btn-swap" onclick="executeTeamSwap(${ai})">${myTeam?'Swap':'Pick'}</button>
    </div>
  </div>`;
}

async function executeTeamSwap(participantIdx) {
  const p = state.participants[participantIdx];
  const newTeam = document.getElementById('swapSel_TEAM')?.value;
  if (!newTeam) { alert('Select a team.'); return; }
  const {tc} = getDraftCounts();
  if ((tc[newTeam]||0) >= MAX_TEAM_DRAFTS) { alert(`${IPL_TEAMS[newTeam].name} is already drafted ${MAX_TEAM_DRAFTS} times!`); return; }
  try {
    setSyncStatus('loading','Saving‚Ä¶');
    await dbPatch('participants', { team_pick: newTeam }, `?id=eq.${p.id}`);
    p.teamPick = newTeam;
    setSyncStatus('ok','Synced');
    renderRedraftScreen();
    renderLeaderboard();
  } catch(e) { setSyncStatus('err','Save failed'); console.error(e); alert(e.message); }
}

async function executeSwap(participantIdx, teamKey) {
  const p = state.participants[participantIdx];
  const newPlayer = document.getElementById(`swapSel_${teamKey}`)?.value;
  if (!newPlayer) { alert('Select a player to swap in.'); return; }

  const {pc} = getDraftCounts();
  if ((pc[newPlayer]||0)>=MAX_PLAYER_DRAFTS) { alert(`${newPlayer} is already drafted ${MAX_PLAYER_DRAFTS} times!`); return; }

  // Foreign limit check ‚Äî count foreigners excluding this slot (since old player is being replaced)
  const newPlayerObj = (IPL_TEAMS[teamKey]?.players||[]).find(pl => pl.name === newPlayer);
  if (newPlayerObj?.foreign && countForeignPicks(p, teamKey) >= MAX_FOREIGN_PER_FANTASY) {
    alert(`Can't swap in ${newPlayer} ‚Äî ${p.name} already has ${MAX_FOREIGN_PER_FANTASY} foreign players!`);
    return;
  }

  const oldPlayer = p.picks[teamKey];
  const frozenSc = oldPlayer ? (state.seasonScores[oldPlayer]||{runs:0,wickets:0,catches:0,runouts:0,stumpings:0}) : null;
  const frozenPts = frozenSc ? frozenSc.runs+frozenSc.wickets*25+frozenSc.catches*5+(frozenSc.runouts||0)*5+(frozenSc.stumpings||0)*5 : 0;

  try {
    setSyncStatus('loading','Saving swap‚Ä¶');

    // Mark old pick as inactive
    if (oldPlayer) {
      await dbPatch('picks', { is_active: false, swapped_at: new Date().toISOString() },
        `?participant_id=eq.${p.id}&team_key=eq.${teamKey}&is_active=eq.true`);
    }

    // Insert new active pick
    await dbPost('picks', { participant_id: p.id, team_key: teamKey, player_name: newPlayer, is_active: true });

    // Log the swap
    await dbPost('swap_history', {
      participant_id: p.id,
      participant_name: p.name,
      team_key: teamKey,
      team_name: IPL_TEAMS[teamKey].name,
      old_player: oldPlayer||'(none)',
      new_player: newPlayer,
      frozen_pts: frozenPts,
      swap_date: new Date().toLocaleDateString()
    });

    // Ensure new player has score entry
    if (!state.seasonScores[newPlayer]) {
      await dbPost('season_scores', { player_name: newPlayer, runs: 0, wickets: 0, catches: 0 });
      state.seasonScores[newPlayer] = {runs:0,wickets:0,catches:0};
    }

    setSyncStatus('ok','Synced');

    // Update local state
    if (!p.pickHistory) p.pickHistory = {};
    if (!p.pickHistory[teamKey]) p.pickHistory[teamKey] = [];
    if (oldPlayer) p.pickHistory[teamKey].push(oldPlayer);
    p.picks[teamKey] = newPlayer;
    state.swapHistory.push({ participantName:p.name, teamKey, teamName:IPL_TEAMS[teamKey].name, oldPlayer:oldPlayer||'(none)', newPlayer, frozenPts, date:new Date().toLocaleDateString() });

    renderRedraftScreen();
    renderParticipantList();
    renderLeaderboard();
  } catch(e) { setSyncStatus('err','Save failed'); console.error(e); alert(e.message); }
}

function renderSwapHistory() {
  const section = document.getElementById('swapHistorySection');
  const logEl = document.getElementById('swapLog');
  if (!state.swapHistory.length) { section.style.display='none'; return; }
  section.style.display='block';
  logEl.innerHTML = [...state.swapHistory].reverse().map(s =>
    `<div class="swap-entry">
      <strong>${s.participantName}</strong>
      <span style="color:var(--muted);font-size:.78rem">${s.teamKey}</span>
      <span>${s.oldPlayer}</span>
      <span class="swap-arrow">‚Üí</span>
      <span style="color:var(--green)">${s.newPlayer}</span>
      ${s.frozenPts ? `<span style="color:var(--gold);font-size:.78rem">(${s.frozenPts}pts frozen)</span>` : ''}
      <span class="swap-meta">${s.date}</span>
    </div>`
  ).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATCH SCORING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPendingResult(r) {
  state.pendingResult = r;
  ['t1','draw','t2'].forEach(k => {
    document.getElementById(`res-${k}`).className = 'res-btn'+(r===k?` sel-${k}`:'');
  });
}

async function importScorecard() {
  if (!state.participants.length) { setImportStatus('error','Complete the draft first!'); return; }
  const scorecardText = document.getElementById('scorecardText').value.trim();
  if (!scorecardText) { setImportStatus('error','Please paste the scorecard text first.'); return; }

  const btn = document.getElementById('importBtn');
  btn.disabled=true; document.getElementById('importIcon').textContent='‚è≥';
  document.getElementById('importPreview').classList.remove('show');
  setImportStatus('loading','Parsing scorecard‚Ä¶');

  const allDrafted = [];
  const seen = new Set();
  TEAM_KEYS.forEach(k => {
    state.participants.forEach(p => {
      if (p.picks[k] && !seen.has(p.picks[k])) {
        seen.add(p.picks[k]);
        allDrafted.push({ player: p.picks[k], team: IPL_TEAMS[k].name, teamKey: k });
      }
    });
  });

  const playerList = allDrafted.map(d => `- ${d.player} (${d.team})`).join('\n');

  const prompt = `You are a cricket scorecard parser for an IPL fantasy league.

Below is pasted scorecard text from an IPL match. Read it carefully.

The fantasy league has drafted these players across all 10 IPL teams. Only players from the two teams in this match will appear in the scorecard:
${playerList}

Tasks:
1. Identify which two IPL teams are playing.
2. For each player listed who played today, extract:
   - runs: runs scored while batting
   - wickets: wickets taken while bowling
   - catches: count of catches taken (look for "c [their name]" in dismissal descriptions, NOT stumpings)
   - runouts: count of run-outs they were involved in. IMPORTANT ‚Äî if a dismissal shows "run out (PlayerA/PlayerB)", BOTH PlayerA AND PlayerB each get 1 run-out credit (full 5 pts each). Count every run-out dismissal where their name appears anywhere in the brackets.
   - stumpings: count of stumpings made (look for "st [their name]" in dismissal descriptions ‚Äî this is always the wicketkeeper)
3. Players not in this match: set not_in_match: true.
4. Players who played but scored 0 everywhere: all fields 0.
5. Detect the match winner.

Scoring reminder: runs√ó1 + wickets√ó25 + catches√ó5 + runouts√ó5 + stumpings√ó5

Respond ONLY with valid JSON, no other text:
{"match_title":"CSK vs MI","t1_name":"Chennai Super Kings","t2_name":"Mumbai Indians","winner":"Chennai Super Kings","players":[{"name":"Player","team":"Team","runs":0,"wickets":0,"catches":0,"runouts":0,"stumpings":0,"not_in_match":false}]}`;

  try {
    // Call our Netlify proxy ‚Äî keeps the API key off GitHub
    const fullPrompt = prompt + '\n\n--- SCORECARD TEXT ---\n\n' + scorecardText;

    const response = await fetch('/.netlify/functions/anthropic', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 2000,
        messages: [{role:'user', content:fullPrompt}]
      })
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    const fullText = (data.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('\n');
    const jsonMatch = fullText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Could not parse AI response.');
    let parsed;
    try {
      parsed = JSON.parse(jsonMatch[0]);
    } catch(jsonErr) {
      // Claude sometimes produces slightly malformed JSON ‚Äî try sanitising it
      const sanitised = jsonMatch[0]
        .replace(/[\x00-\x1F\x7F]/g, ' ')  // strip control characters
        .replace(/,\s*([}\]])/g, '$1');        // remove trailing commas
      parsed = JSON.parse(sanitised);
    }
    if (!parsed.players) throw new Error('Unexpected response format.');

    if (parsed.winner) {
      const wl = parsed.winner.toLowerCase();
      if (wl.includes((parsed.t1_name||'').toLowerCase().split(' ')[0])) setPendingResult('t1');
      else setPendingResult('t2');
    }
    if (parsed.t1_name) document.getElementById('res-t1').textContent=`üîµ ${parsed.t1_name} Won`;
    if (parsed.t2_name) document.getElementById('res-t2').textContent=`üü† ${parsed.t2_name} Won`;

    state.pendingImport = { parsed, t1name: parsed.t1_name, t2name: parsed.t2_name };
    renderImportPreview(parsed, allDrafted);
    setImportStatus('success', `‚úì ${parsed.match_title||'Match'} parsed${parsed.winner?' ¬∑ Winner: '+parsed.winner:''}`);
  } catch(e) { console.error(e); setImportStatus('error',`Error: ${e.message}`); }

  btn.disabled=false; document.getElementById('importIcon').textContent='üîó';
}

function setImportStatus(type,msg) {
  const el=document.getElementById('importStatus');
  if (type==='loading') el.innerHTML=`<div class="spinner"></div><span class="status-loading">${msg}</span>`;
  else if (type==='success') el.innerHTML=`<span class="status-success">${msg}</span>`;
  else el.innerHTML=`<span class="status-error">${msg}</span>`;
}

function renderImportPreview(parsed, allDrafted) {
  const inMatch = parsed.players.filter(p=>!p.not_in_match);
  let hitCount=0;
  const rows = inMatch.map(p => {
    const drafted = allDrafted.find(d=>d.player.toLowerCase()===p.name.toLowerCase());
    if (!drafted) return '';
    hitCount++;
    const pts=(p.runs||0)+(p.wickets||0)*25+(p.catches||0)*5+(p.runouts||0)*5+(p.stumpings||0)*5;
    return `<div class="preview-player-row hit">
      <div><strong>${p.name}</strong> <span style="color:var(--muted);font-size:.72rem">${p.team}</span></div>
      <div class="preview-stats"><div>${p.runs||0} <span>runs</span></div><div>${p.wickets||0} <span>wkts</span></div><div>${p.catches||0} <span>ctch</span></div><div>${p.runouts||0} <span>r/o</span></div><div>${p.stumpings||0} <span>st</span></div><div style="color:var(--gold);font-weight:600">+${pts} pts</div></div>
      <span class="badge-found">DRAFTED</span>
    </div>`;
  }).filter(Boolean).join('');
  const missRows = allDrafted.filter(d=>{
    const f=parsed.players.find(p=>p.name.toLowerCase()===d.player.toLowerCase());
    return !f||f.not_in_match;
  }).map(d=>`<div class="preview-player-row miss"><span>${d.player} <span style="font-size:.72rem">${d.teamKey}</span></span><span style="font-size:.72rem">Not in today's match</span><span class="badge-miss">SKIP</span></div>`).join('');
  document.getElementById('previewCount').textContent=`${hitCount} drafted players found in this match`;
  document.getElementById('previewList').innerHTML=rows+missRows;
  document.getElementById('applyNote').textContent=`${hitCount} player(s) will be updated`;
  document.getElementById('importPreview').classList.add('show');
}

async function applyMatch() {
  const imp = state.pendingImport;
  if (!imp) { alert('Nothing to apply. Import a scorecard first.'); return; }
  const {parsed} = imp;
  const updates = [];

  for (const p of parsed.players) {
    if (p.not_in_match) continue;
    const nameLower = p.name.toLowerCase();
    let draftedAs = null;
    TEAM_KEYS.forEach(k => {
      state.participants.forEach(part => {
        if (part.picks[k]&&part.picks[k].toLowerCase()===nameLower) draftedAs=part.picks[k];
      });
    });
    if (!draftedAs) continue;
    const runs=parseInt(p.runs)||0, wkts=parseInt(p.wickets)||0, ctch=parseInt(p.catches)||0, rnout=parseInt(p.runouts)||0, stmp=parseInt(p.stumpings)||0;
    updates.push({ player:draftedAs, team:p.team, runs, wkts, catches:ctch, runouts:rnout, stumpings:stmp, pts:runs+wkts*25+ctch*5+rnout*5+stmp*5 });
  }

  try {
    setSyncStatus('loading','Saving match‚Ä¶');

    // Upsert season scores
    for (const u of updates) {
      const existing = state.seasonScores[u.player];
      if (existing) {
        const newRuns=existing.runs+u.runs, newWkts=existing.wickets+u.wkts, newCtch=existing.catches+u.catches, newRnout=(existing.runouts||0)+u.runouts, newStmp=(existing.stumpings||0)+u.stumpings;
        await dbPatch('season_scores', { runs:newRuns, wickets:newWkts, catches:newCtch, runouts:newRnout, stumpings:newStmp }, `?player_name=eq.${encodeURIComponent(u.player)}`);
        state.seasonScores[u.player] = { runs:newRuns, wickets:newWkts, catches:newCtch, runouts:newRnout, stumpings:newStmp };
      } else {
        await dbPost('season_scores', { player_name:u.player, runs:u.runs, wickets:u.wkts, catches:u.catches, runouts:u.runouts, stumpings:u.stumpings });
        state.seasonScores[u.player] = { runs:u.runs, wickets:u.wkts, catches:u.catches, runouts:u.runouts, stumpings:u.stumpings };
      }
    }

    // Save match to history
    const [matchRow] = await dbPost('match_history', {
      title: parsed.match_title||`${imp.t1name} vs ${imp.t2name}`,
      match_date: new Date().toLocaleDateString(),
      result: state.pendingResult,
      t1_name: imp.t1name,
      t2_name: imp.t2name,
      updates
    });

    const newMatch = { id:matchRow.id, title:matchRow.title, date:matchRow.match_date, result:matchRow.result, t1name:matchRow.t1_name, t2name:matchRow.t2_name, updates };
    state.matchHistory.push(newMatch);
    applyMatchResultToTeamWins(newMatch, true);

    setSyncStatus('ok','Synced');

    // Reset
    state.pendingImport=null; state.pendingResult=null;
    document.getElementById('scorecardText').value='';
    document.getElementById('importPreview').classList.remove('show');
    ['t1','draw','t2'].forEach(k=>document.getElementById(`res-${k}`).className='res-btn');
    document.getElementById('res-t1').textContent='‚Äî Team 1 Won';
    document.getElementById('res-t2').textContent='‚Äî Team 2 Won';
    setImportStatus('success',`‚úì Match applied! ${updates.length} player score(s) updated.`);
    renderMatchLog(); renderLeaderboard();
  } catch(e) { setSyncStatus('err','Save failed'); console.error(e); alert(e.message); }
}

function renderMatchLog() {
  const el=document.getElementById('matchLog');
  if (!state.matchHistory.length) { el.innerHTML='<div class="empty-state">No matches scored yet.</div>'; return; }
  el.innerHTML=[...state.matchHistory].reverse().map((m,ri)=>{
    const i=state.matchHistory.length-1-ri;
    const resultText=m.result==='draw'?'Draw':m.result==='t1'?`${m.t1name} Won`:`${m.t2name} Won`;
    const chipClass=m.result==='draw'?'chip-draw':m.result==='t1'?'chip-t1':'chip-t2';
    const chips=(m.updates||[]).map(u=>`<span class="player-update-chip">${u.player}: ${u.runs}r ${u.wkts}w ${u.catches}c ${u.runouts||0}ro ${u.stumpings||0}st = <strong>+${u.pts}pts</strong></span>`).join('');
    return `<div class="match-entry">
      <div class="match-entry-header">
        <div><div class="match-title-text">${m.title}</div><div class="match-date-text">${m.date}</div></div>
        <div style="display:flex;align-items:center;gap:.6rem">
          <span class="match-result-chip ${chipClass}">${resultText}</span>
          <button class="btn-ghost" onclick="removeMatch('${m.id}',${i})">‚úï Remove</button>
        </div>
      </div>
      <div class="match-player-updates">${chips||'<span style="color:var(--muted);font-size:.8rem">No drafted players scored</span>'}</div>
    </div>`;
  }).join('');
}

async function removeMatch(id, i) {
  if (!confirm('Remove this match and reverse its points?')) return;
  const m = state.matchHistory[i];
  try {
    setSyncStatus('loading','Removing‚Ä¶');
    for (const u of (m.updates||[])) {
      const sc = state.seasonScores[u.player];
      if (sc) {
        const newRuns=sc.runs-u.runs, newWkts=sc.wickets-u.wkts, newCtch=sc.catches-u.catches, newRnout=(sc.runouts||0)-u.runouts, newStmp=(sc.stumpings||0)-u.stumpings;
        await dbPatch('season_scores', { runs:newRuns, wickets:newWkts, catches:newCtch, runouts:newRnout, stumpings:newStmp }, `?player_name=eq.${encodeURIComponent(u.player)}`);
        state.seasonScores[u.player]={runs:newRuns,wickets:newWkts,catches:newCtch,runouts:newRnout,stumpings:newStmp};
      }
    }
    await dbDelete('match_history', `?id=eq.${id}`);
    applyMatchResultToTeamWins(m, false);
    state.matchHistory.splice(i,1);
    setSyncStatus('ok','Synced');
    renderMatchLog(); renderLeaderboard();
  } catch(e) { setSyncStatus('err','Failed'); console.error(e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcSeasonPoints(participant) {
  let playerPts=0;
  const breakdown={};
  TEAM_KEYS.forEach(k => {
    const current=participant.picks[k];
    const history=participant.pickHistory?.[k]||[];
    const allInSlot=[...history,current].filter(Boolean);
    if (!allInSlot.length) return;
    let slotPts=0;
    const slotPlayers=allInSlot.map(name=>{
      const sc=state.seasonScores[name]||{runs:0,wickets:0,catches:0,runouts:0,stumpings:0};
      const pts=sc.runs+sc.wickets*25+sc.catches*5+(sc.runouts||0)*5+(sc.stumpings||0)*5;
      slotPts+=pts;
      return {name,sc,pts};
    });
    playerPts+=slotPts;
    breakdown[k]={current,history,slotPlayers,slotPts};
  });

  // Team pick points
  const tw = participant.teamPick ? (state.teamWins[participant.teamPick]||{wins:0,draws:0}) : null;
  const teamPts = tw ? tw.wins*TEAM_WIN_PTS + tw.draws*TEAM_DRAW_PTS : 0;
  const total = playerPts + teamPts;

  return {playerPts, teamPts, total, breakdown, teamPick:participant.teamPick, teamWinData:tw};
}

function renderLeaderboard() {
  const el=document.getElementById('leaderboardContent');
  if (!state.participants.length) { el.innerHTML='<div class="empty-state">Complete the draft first.</div>'; return; }

  const sorted=state.participants.map((p,i)=>({...p,i,...calcSeasonPoints(p)})).sort((a,b)=>b.total-a.total);

  const rows=sorted.map((p,rank)=>{
    const rankClass=rank<3?`rank-${rank+1}`:'';
    const pickCount=TEAM_KEYS.filter(k=>p.picks[k]).length;
    const foreignCount = countForeignPicks(p);
    const topPicks=TEAM_KEYS.filter(k=>p.picks[k])
      .sort((a,b)=>(p.breakdown[b]?.slotPts||0)-(p.breakdown[a]?.slotPts||0))
      .slice(0,3).map(k=>{
        const playerObj = IPL_TEAMS[k].players.find(pl=>pl.name===p.picks[k]);
        return `<strong>${playerObj?.foreign?'üåç':'üáÆüá≥'} ${p.picks[k]}</strong> +${p.breakdown[k]?.slotPts||0}pts`;
      }).join(' ¬∑ ');
    return `<tr onclick="toggleDetail(${rank})" style="cursor:pointer">
      <td><span class="rank-badge ${rankClass}">${rank+1}</span></td>
      <td>
        <div style="font-weight:600">${p.name}</div>
        <div style="font-size:.75rem;color:var(--muted)">${pickCount}/10 picks ¬∑ üåç ${foreignCount}/${MAX_FOREIGN_PER_FANTASY} foreign${p.teamPick?' ¬∑ üèÜ '+p.teamPick:''}</div>
      </td>
      <td><div class="picks-mini">${topPicks||'‚Äî'}</div></td>
      <td>
        <div class="pts-big">${p.total}</div>
        <div class="pts-breakdown">${p.playerPts} player${p.teamPts?` + <span class="pts-gold">${p.teamPts} team</span>`:''}</div>
      </td>
    </tr>
    <tr class="detail-row" id="detail-${rank}"><td colspan="4">
      <div class="detail-grid">
        ${TEAM_KEYS.map(k=>{
          const bd=p.breakdown[k];
          if (!bd) return `<div class="detail-chip" style="opacity:.4"><div class="dc-team">${k} ‚Äî not picked</div></div>`;
          const histLine=bd.history&&bd.history.length
            ?`<div style="font-size:.68rem;color:var(--muted);margin-top:.1rem">${bd.history.map(h=>{const hs=state.seasonScores[h]||{runs:0,wickets:0,catches:0,runouts:0,stumpings:0};return `‚Ü© ${h} (${hs.runs+hs.wickets*25+hs.catches*5+(hs.runouts||0)*5+(hs.stumpings||0)*5}pts)`;}).join(', ')}</div>`:'';
          const curSc=state.seasonScores[bd.current]||{runs:0,wickets:0,catches:0,runouts:0,stumpings:0};
          const playerObj = bd.current ? IPL_TEAMS[k].players.find(pl=>pl.name===bd.current) : null;
          return `<div class="detail-chip">
            <div class="dc-team">${k} ${playerObj?.foreign?'üåç':'üáÆüá≥'} <span class="dc-pts">${bd.slotPts}pts</span></div>
            <div>${bd.current||'‚Äî'}</div>
            ${bd.current?`<div style="font-size:.7rem;color:var(--muted)">${curSc.runs}r ¬∑ ${curSc.wickets}w ¬∑ ${curSc.catches}c ¬∑ ${curSc.runouts||0}ro ¬∑ ${curSc.stumpings||0}st</div>`:''}
            ${histLine}
          </div>`;
        }).join('')}
        ${p.teamPick
          ? `<div class="detail-chip" style="border-color:rgba(255,214,0,.3)">
               <div class="dc-team" style="color:var(--gold)">üèÜ TEAM DRAFT <span class="dc-pts" style="color:var(--gold)">${p.teamPts}pts</span></div>
               <div>${IPL_TEAMS[p.teamPick]?.name||p.teamPick} (${p.teamPick})</div>
               <div style="font-size:.7rem;color:var(--muted)">${p.teamWinData?.wins||0} wins ¬∑ ${p.teamWinData?.draws||0} draws</div>
             </div>`
          : `<div class="detail-chip" style="opacity:.4"><div class="dc-team">üèÜ TEAM ‚Äî not picked</div></div>`}
      </div>
    </td></tr>`;
  }).join('');

  el.innerHTML=`<table class="lb-table">
    <thead><tr><th>#</th><th>Participant</th><th>Top Picks</th><th>Season Pts</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function toggleDetail(rank) {
  document.getElementById(`detail-${rank}`).classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function importSquads() {
  const btn = document.getElementById('importSquadsBtn');
  const status = document.getElementById('importSquadsStatus');
  btn.disabled = true;
  status.innerHTML = '<span style="color:var(--gold)">‚è≥ Uploading squads to Supabase‚Ä¶</span>';

  try {
    // Delete all existing rows first, then re-insert clean
    await dbDelete('squads', '?id=gte.0');

    // Insert in batches of 50
    for (let i = 0; i < SQUAD_SEED.length; i += 50) {
      const batch = SQUAD_SEED.slice(i, i + 50);
      await sb('POST', 'squads', batch, '', { 'Prefer': 'return=minimal' });
    }

    // Reload squads into live IPL_TEAMS
    const squadRows = await dbGet('squads', '?order=team_key.asc,player_name.asc');
    IPL_TEAMS = buildIPLTeamsFromRows(squadRows);
    TEAM_KEYS.length = 0;
    Object.keys(IPL_TEAMS).sort().forEach(k => TEAM_KEYS.push(k));

    renderDraftGrid();

    status.innerHTML = `<span style="color:var(--green)">‚úì ${SQUAD_SEED.length} players across ${TEAM_KEYS.length} teams synced successfully.</span>`;
  } catch(e) {
    status.innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
    console.error(e);
  }
  btn.disabled = false;
}

async function resetEverything() {
  const password = prompt('Enter the admin password to reset all data:');
  if (password === null) return;
  if (password !== 'INDIA') {
    alert('‚ùå Incorrect password. Reset cancelled.');
    return;
  }
  const confirmed = confirm('‚ö†Ô∏è Password accepted. Are you sure you want to wipe ALL league data?\n\nThis cannot be undone.');
  if (!confirmed) return;

  const btn = document.getElementById('resetBtn');
  const status = document.getElementById('resetStatus');
  btn.disabled = true;
  status.innerHTML = '<span style="color:var(--gold)">‚è≥ Resetting all tables‚Ä¶</span>';

  try {
    setSyncStatus('loading', 'Resetting‚Ä¶');

    // Delete all rows from each table in correct order (respecting FK constraints)
    await dbDelete('swap_history', '?id=neq.00000000-0000-0000-0000-000000000000');
    await dbDelete('match_history', '?id=neq.00000000-0000-0000-0000-000000000000');
    await dbDelete('season_scores', '?player_name=neq.__placeholder__');
    await dbDelete('picks', '?id=neq.00000000-0000-0000-0000-000000000000');
    await dbDelete('participants', '?id=neq.00000000-0000-0000-0000-000000000000');
    await dbPatch('settings', { ipl_winner: null }, '?id=eq.global');

    // Reset local state
    state.participants = [];
    state.seasonScores = {};
    state.matchHistory = [];
    state.swapHistory = [];
    state.iplWinner = null;
    state.activeParticipant = null;
    state.activeRedraftParticipant = null;
    state.pendingImport = null;
    state.pendingResult = null;

    setSyncStatus('ok', 'Synced');
    status.innerHTML = '<span style="color:var(--green)">‚úì All data has been wiped. Ready for a fresh start!</span>';
    renderAll();
  } catch(e) {
    setSyncStatus('err', 'Reset failed');
    status.innerHTML = `<span style="color:var(--red)">Error: ${e.message}</span>`;
    console.error(e);
  }
  btn.disabled = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(name,btn) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name==='leaderboard') renderLeaderboard();
  if (name==='scoring') renderMatchLog();
  if (name==='redraft') renderRedraftScreen();
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT ‚Äî load from Supabase
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadAll();
</script>
</body>
</html>
